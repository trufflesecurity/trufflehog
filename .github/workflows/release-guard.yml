name: Release Guard
on:
  release:
    types: [created]

permissions:
  contents: write
  actions: read

jobs:
  unset-latest:
    runs-on: ubuntu-latest
    steps:
      - name: Restore previous release as latest if needed
        run: |
          TAG="$RELEASE_TAG"

          # If the Release workflow already succeeded for this tag, the
          # pipeline intentionally set "latest" â€” don't undo it.
          RELEASE_RUN_STATUS=$(gh run list \
            --workflow=release.yml \
            --json conclusion,headBranch \
            -q "[.[] | select(.headBranch == \"$TAG\")] | .[0].conclusion")

          if [ "$RELEASE_RUN_STATUS" = "success" ]; then
            echo "Release workflow succeeded for $TAG, skipping guard."
            exit 0
          fi

          LATEST_TAG=$(gh release list --json tagName,isLatest -q '.[] | select(.isLatest) | .tagName')
          if [ "$LATEST_TAG" != "$TAG" ]; then
            echo "Release is not marked as latest (latest is $LATEST_TAG), skipping."
            exit 0
          fi

          echo "Release $TAG is marked as latest, finding previous release..."

          PREVIOUS_TAG=$(gh release list --exclude-drafts --exclude-pre-releases --json tagName -q '.[1].tagName')

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous release found, cannot restore. Exiting."
            exit 0
          fi

          echo "Restoring $PREVIOUS_TAG as latest..."
          gh release edit "$PREVIOUS_TAG" --latest
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
